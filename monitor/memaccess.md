# 8086 メモリアクセスとバスサイクル

8086は16ビットのデータバスを持ち、一度に最大16ビット（1ワード）のデータにアクセスできます。しかし、8ビット（1バイト）単位でのアクセスもサポートされています。どのバイト（上位バイト/下位バイト）にアクセスするかを制御するために、アドレスバスの最下位ビットA0と、BHE#（Bus High Enable）という特別な制御信号を組み合わせて使用します。

-   **A0**: アドレスバスの最下位ビット。アクセス対象が偶数アドレスか奇数アドレスかを示します。
-   **BHE#**: 上位バイトイネーブル信号（アクティブロー）。データバスの上位8ビット（D15-D8）が有効かどうかを示します。

以下に、A0とBHE#の組み合わせによるメモリアクセスのパターンを示します。

| BHE# | A0 | 転送されるデータ | 説明 |
| :--- | :- | :--- | :--- |
| 0 (Low) | 0 (Low) | **16ビットワード** |偶数アドレス(`A0=0`)から始まる1ワード（2バイト）全体にアクセスします。データはD15-D0の16ビット全てを使って転送されます。 |
| 0 (Low) | 1 (High) | **上位バイト（8ビット）** |奇数アドレス(`A0=1`)の1バイトにアクセスします。データはデータバスの上位8ビット（D15-D8）を使って転送されます。 |
| 1 (High) | 0 (Low) | **下位バイト（8ビット）** |偶数アドレス(`A0=0`)の1バイトにアクセスします。データはデータバスの下位8ビット（D7-D0）を使って転送されます。 |
| 1 (High) | 1 (High) | **なし** |この組み合わせは通常は使用されません。バスサイクルは発生しません。 |

---

### 具体例

-   **偶数アドレス `0x1000` から1ワード読み書きする場合:**
    -   A0 = `0`
    -   BHE# = `0`
    -   アドレス `0x1000` (下位バイト) と `0x1001` (上位バイト) の両方に同時にアクセスします。

-   **奇数アドレス `0x1001` から1バイト読み書きする場合:**
    -   A0 = `1`
    -   BHE# = `0`
    -   アドレス `0x1001` のバイトのみにアクセスし、データはD15-D8で転送されます。

-   **偶数アドレス `0x1000` から1バイト読み書きする場合:**
    -   A0 = `0`
    -   BHE# = `1`
    -   アドレス `0x1000` のバイトのみにアクセスし、データはD7-D0で転送されます。

---
## Raspberry Pi Picoにおける実装アルゴリズム

`main.cpp`の`core1_entry`関数では、上記の仕様に基づいてV30 CPUのメモリアクセスを処理するコントローラを実装しています。以下にその読み出し・書き出しロジックのアルゴリズムを示します。

このアルゴリズムは、CPUが発行する制御信号（`ALE`, `RD#`, `WR#`）とアドレス信号（`A0`, `BHE#`）を監視し、Pico内のRAMに対して適切な操作を行います。

### メモリ読み出し (Memory Read) の処理 (最適化版)

CPUがメモリからデータを読み出す際のアルゴリズムです。CPUはアクセス時に不要なデータバスの半分を無視するという特性を利用して、Pico側のロジックは以下のように最適化されています。

1.  CPUが`RD#`信号をアクティブ（Low）にするのを待ちます。
2.  その時点でのアドレスバス（`addr`）を読み取ります。
3.  要求されたアドレス`addr`を、`& ~1`のビット演算によって偶数アドレスにアライン（整列）します。これを`aligned_addr`とします。
    -   `addr`が偶数なら、`aligned_addr`は`addr`のままです。
    -   `addr`が奇数なら、`aligned_addr`は`addr - 1`になります。
4.  PicoのRAMから常に16ビットのワードデータ、`ram[aligned_addr]`（下位バイト）と`ram[aligned_addr + 1]`（上位バイト）を読み出します。
5.  この16ビットデータをデータバス（AD15-AD0）全体に出力します。
6.  CPUは`A0`と`BHE#`の状態に基づき、バスに出力された16ビットデータの中から必要な8ビットまたは16ビットを選択して読み取ります。

この方法により、Pico側は`A0`や`BHE#`の状態を判別する必要がなくなり、より高速でシンプルな処理が実現できています。

### メモリ書き込み (Memory Write) の処理

CPUがメモリにデータを書き込む際のアルゴリズムです。`main.cpp`のコードは以下のように動作します。

1.  CPUが`WR#`信号をアクティブ（Low）にするのを待ちます。
2.  `WR#`がアクティブな間に、アドレスバス（`addr`）と`BHE#`信号の状態が確定されます。
3.  CPUが`WR#`を非アクティブ（High）にした直後に、データバス（AD15-AD0）から16ビットのデータを読み取ります。
4.  `A0`と`BHE#`の状態に応じて、以下の条件分岐を実行します。

    -   **もし `BHE#` が Low かつ `A0` が Low なら (ワード書き込み):**
        -   データバスの下位8ビット（AD7-AD0）を `ram[addr]` に書き込みます。
        -   データバスの上位8ビット（AD15-AD8）を `ram[addr+1]` に書き込みます。

    -   **もし `BHE#` が Low かつ `A0` が High なら (上位バイト書き込み):**
        -   データバスの上位8ビット（AD15-AD8）を `ram[addr]` (奇数アドレス) に書き込みます。

    -   **もし `BHE#` が High かつ `A0` が Low なら (下位バイト書き込み):**
        -   データバスの下位8ビット（AD7-AD0）を `ram[addr]` (偶数アドレス) に書き込みます。

これにより、`main.cpp`のコードは8086のバス仕様通りに動作することが保証されます。