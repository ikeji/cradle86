# `main.asm` の割り込みサービスルーチン (ISR)

このドキュメントは `main.asm` で定義されている割り込みサービスルーチン（ISR）の機能と実装について説明します。mini-dosカーネルは、デバッグとロギングの目的ですべての割り込み（0から255）を捕捉します。

## 概要

`GEN_INT_HANDLER` マクロを使用して、256個の割り込みベクタそれぞれに対応する汎用的な割り込みハンドラが生成されます。各ハンドラは、どの割り込みが発生したかをシリアルポート（COM1）に出力し、特定の割り込み（特に `INT 21h`）に対しては追加情報をログに記録します。

主な目的は、システムコールやハードウェア割り込みを監視し、アプリケーション（例：`COMMAND.COM`）がOSとどのように対話しているかを開発者が理解するのを助けることです。

## 一般的な割り込み処理の流れ

すべての割り込みハンドラ (`isr_0` から `isr_255`) は、以下の共通の処理フローを実行します。

1.  **レジスタの保存**: スタックにすべての汎用レジスタ (`ax`, `cx`, `dx`, `bx`, `sp`, `bp`, `si`, `di`) とセグメントレジスタ (`ds`, `es`) をプッシュして、現在のCPUコンテキストを保存します。
2.  **カーネルモードへの移行**:
    *   `DS` レジスタをカーネルのデータセグメント (`KERNEL_SEGMENT`) に設定し、カーネルのグローバル変数にアクセスできるようにします。
    *   呼び出し元のスタックポインタ (`SS:SP`) をカーネル内の `saved_ss` および `saved_sp` 変数に保存します。
    *   スタックをカーネル自身のスタックに切り替えます。
3.  **情報ロギング**:
    *   "Interrupt 0xXX" という形式で、発生した割り込み番号（16進数）をCOM1ポートに出力します。
4.  **呼び出し元への復帰準備**:
    *   呼び出し元のスタックフレームにあるフラグワードのキャリーフラグをクリアし、処理が成功したことを示します。
    *   スタックを呼び出し元のスタックに戻します。
5.  **レジスタの復元とリターン**: スタックからすべてのレジスタをポップし、`iret` 命令で割り込みから復帰します。

## メモリ管理

mini-dosカーネルは、プログラムがロードされる際に全メモリを割り当てる方式を採用しています。

-   **メモリモデル**: OSは起動後、最初のプログラム（`COMMAND.COM`）に、物理アドレス `0x01000` から `0x10FFF` までの64KBのメモリブロック全体を割り当てます。
-   **メモリの解放**: `COMMAND.COM`のようなプログラムは、自身のメモリブロックを `INT 21h, AH=4Ah`（メモリブロックのサイズ変更）を使って縮小することで、OSが他のプログラムをロードするための空きメモリを作ります。
-   **`free_mem_start_segment`**: このカーネル変数は、空きメモリ領域の開始セグメントを指します。初期状態では、全メモリが割り当て済みのため、メモリの最上位セグメント (`0x10FF`) に設定されています。

## `INT 21h` - DOS API ファンクションコール

`INT 21h` はDOSの主要なAPIであるため、特別な処理が行われます。一般的な割り込み情報に加えて、`AH` レジスタの値（どのサブファンクションが呼ばれたかを示す）もログに出力します。

### 対応している `INT 21h` サブファンクション

現在、以下の `AH` の値に対応するサブファンクションのロギングが実装されています。

-   **`AH = 02h` (文字出力)**
    *   `DL` レジスタの値を16進数でログに出力します。
    *   `DL` の値が表示可能なASCII文字（0x20-0x7E）である場合、その文字も `ASCII="c"` の形式でログに出力します。
    *   また、`DL` の文字をCOM2ポートにも出力します。

-   **`AH = 09h` (文字列の表示)**
    *   `DS:DX`が指す`$`で終端された文字列を表示します。
    *   `DS`と`DX`の値を16進数でCOM1にログ出力します。
    *   文字列の内容のうち表示可能文字をCOM1にログ出力します。
    *   文字列の内容をCOM2にも直接出力します。

-   **`AH = 3Dh` (ファイルを開く)**
    *   呼び出し元が `AL` で指定したオープンモードと、`DS:DX` で指定したファイル名をログに出力します。
    *   ファイルハンドルとして、常に `42` を `AX` レジスタに返します。

-   **`AH = 3Eh` (ファイルのクローズ)**
    *   `BX`（ファイルハンドル）の値をログに出力します。

-   **`AH = 3Fh` (ファイルまたはデバイスからの読み込み)**
    *   `BX`（ファイルハンドル）、`CX`（読み込みバイト数）、`DS:DX`（バッファアドレス）の値をログに出力します。
    *   `AX` レジスタに元の `CX` の値を詰めて返します。

-   **`AH = 42h` (ファイルポインタの移動 - LSEEK)**
    *   `AL`（移動モード）、`BX`（ファイルハンドル）、`CX:DX`（オフセット）の値をログに出力します。
    *   `DX:AX` レジスタペアに、元の `CX:DX` の値を詰めて返します（新しいファイルポインタ位置として）。

-   **`AH = 48h` (メモリの割り当て)**
    *   `BX`（要求パラグラフ数）で指定されたサイズのメモリブロックを、`free_mem_start_segment`から始まる空き領域に割り当てようと試みます。
    *   初期状態では空きメモリが0のため、`AH=4Ah`でメモリが解放されない限り、この呼び出しは失敗します。
    *   **成功した場合**:
        *   `AX`に割り当てられたブロックのセグメントアドレスを返します。
        *   キャリーフラグはクリアされます。
    *   **失敗した場合**（要求サイズが利用可能サイズより大きい場合）:
        *   キャリーフラグをセットします。
        *   `AX`にエラーコード `8` （メモリ不足）を返します。
        *   `BX`に利用可能な最大の連続ブロックサイズ（パラグラフ単位）を返します。

-   **`AH = 49h` (メモリブロックの解放)**
    *   この呼び出しは捕捉されますが、ログ出力以外に特別なアクションは実行されません（スタブ実装）。

-   **`AH = 4Ah` (メモリブロックのサイズ変更)**
    *   `ES:0`で指定されたメモリブロックのサイズを`BX`（新しいサイズ）に変更します。
    *   主にプログラムが自身のメモリ割り当てを縮小し、空きメモリをOSに返還するために使われます。
    *   この呼び出しにより `free_mem_start_segment` の値が更新され、新しい空き領域が生まれます。
    *   成功した場合、`BX`には利用可能な最大の連続ブロックサイズ（パラグラフ単位）を返します。

-   **`AH = 25h` (割り込みベクタの設定)**
    *   `AL` で指定された割り込み番号のベクタを、`DS:DX` で指定された新しいハンドラアドレスに設定します。
    *   `AL` (割り込み番号)、`DS` (セグメント)、`DX` (オフセット) の値をログに出力します。

-   **`AH = 30h` (DOSバージョンの取得)**
    *   `AH` にマイナーバージョン (11 = 0Bh)、`AL` にメジャーバージョン (2) を返します。したがって `AX` は `0x0B02` になります。
    *   `BX` と `CX` は `0` にクリアされます。

-   **`AH = 50h` (現在のPSPを設定)**
    *   `BX` レジスタで指定された新しいPSP（プログラムセグメントプレフィックス）のセグメント値をカーネル変数 `current_psp` に保存します。

-   **`AH = 50h` (現在のPSPを設定)**
    *   `BX` レジスタで指定された新しいPSP（プログラムセグメントプレフィックス）のセグメント値をカーネル変数 `current_psp` に保存します。

これら以外の `INT 21h` 呼び出しや、その他の割り込み (`INT 0`～`INT FF`) は、単に割り込み番号が呼び出されたことだけがログに記録されます。

## ヘルパー関数

ISRのロギング機能は、以下のヘルパー関数によって実現されています。

-   `print_string_com1`: ヌル終端文字列をCOM1ポートに出力します。
-   `print_al_hex`: `AL` レジスタの値を2桁の16進数文字列としてCOM1ポートに出力します。
-   `print_nibble_from_al`: `AL` の下位4ビットを16進文字として出力します。`print_al_hex` から使用されます。
-   `print_char_com1`: `AL` レジスタ内の単一文字をCOM1ポートに出力します。
