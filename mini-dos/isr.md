# `main.asm` の割り込みサービスルーチン (ISR)

このドキュメントは `main.asm` で定義されている割り込みサービスルーチン（ISR）の機能と実装について説明します。mini-dosカーネルは、デバッグとロギングの目的ですべての割り込み（0から255）を捕捉します。

## 概要

`GEN_INT_HANDLER` マクロを使用して、256個の割り込みベクタそれぞれに対応する汎用的な割り込みハンドラが生成されます。各ハンドラは、どの割り込みが発生したかをシリアルポート（COM1）に出力し、特定の割り込み（特に `INT 21h`）に対しては追加情報をログに記録します。

主な目的は、システムコールやハードウェア割り込みを監視し、アプリケーション（例：`COMMAND.COM`）がOSとどのように対話しているかを開発者が理解するのを助けることです。

## 一般的な割り込み処理の流れ

すべての割り込みハンドラ (`isr_0` から `isr_255`) は、以下の共通の処理フローを実行します。

1.  **レジスタの保存**: スタックにすべての汎用レジスタ (`ax`, `cx`, `dx`, `bx`, `sp`, `bp`, `si`, `di`) とセグメントレジスタ (`ds`, `es`) をプッシュして、現在のCPUコンテキストを保存します。
2.  **カーネルモードへの移行**:
    *   `DS` レジスタをカーネルのデータセグメント (`KERNEL_SEGMENT`) に設定し、カーネルのグローバル変数にアクセスできるようにします。
    *   呼び出し元のスタックポインタ (`SS:SP`) をカーネル内の `saved_ss` および `saved_sp` 変数に保存します。
    *   スタックをカーネル自身のスタックに切り替えます。
3.  **情報ロギング**:
    *   "Interrupt 0xXX" という形式で、発生した割り込み番号（16進数）をCOM1ポートに出力します。
4.  **呼び出し元への復帰準備**:
    *   呼び出し元のスタックフレームにあるフラグワードのキャリーフラグをクリアし、処理が成功したことを示します。
    *   スタックを呼び出し元のスタックに戻します。
5.  **レジスタの復元とリターン**: スタックからすべてのレジスタをポップし、`iret` 命令で割り込みから復帰します。

## `INT 21h` - DOS API ファンクションコール

`INT 21h` はDOSの主要なAPIであるため、特別な処理が行われます。一般的な割り込み情報に加えて、`AH` レジスタの値（どのサブファンクションが呼ばれたかを示す）もログに出力します。

### 対応している `INT 21h` サブファンクション

現在、以下の `AH` の値に対応するサブファンクションのロギングが実装されています。

-   **`AH = 02h` (文字出力)**
    *   `DL` レジスタの値を16進数でログに出力します。
    *   `DL` の値が表示可能なASCII文字（0x20-0x7E）である場合、その文字も `ASCII="c"` の形式でログに出力します。
    *   また、`DL` の文字をCOM2ポートにも出力します。

-   **`AH = 3Dh` (ファイルを開く)**
    *   呼び出し元が `AL` で指定したオープンモードと、`DS:DX` で指定したファイル名をログに出力します。
    *   ファイルハンドルとして、常に `42` を `AX` レジスタに返します。

-   **`AH = 3Eh` (ファイルのクローズ)**
    *   `BX`（ファイルハンドル）の値をログに出力します。

-   **`AH = 3Fh` (ファイルまたはデバイスからの読み込み)**
    *   `BX`（ファイルハンドル）、`CX`（読み込みバイト数）、`DS:DX`（バッファアドレス）の値をログに出力します。
    *   `AX` レジスタに元の `CX` の値を詰めて返します。

-   **`AH = 42h` (ファイルポインタの移動 - LSEEK)**
    *   `AL`（移動モード）、`BX`（ファイルハンドル）、`CX:DX`（オフセット）の値をログに出力します。
    *   `DX:AX` レジスタペアに、元の `CX:DX` の値を詰めて返します（新しいファイルポインタ位置として）。

-   **`AH = 49h` (メモリブロックの解放)**
    *   この呼び出しは捕捉されますが、ログ出力以外に特別なアクションは実行されません（スタブ実装）。

-   **`AH = 50h` (現在のPSPを設定)**
    *   `BX` レジスタで指定された新しいPSP（プログラムセグメントプレフィックス）のセグメント値をカーネル変数 `current_psp` に保存します。

これら以外の `INT 21h` 呼び出しや、その他の割り込み (`INT 0`～`INT FF`) は、単に割り込み番号が呼び出されたことだけがログに記録されます。

## ヘルパー関数

ISRのロギング機能は、以下のヘルパー関数によって実現されています。

-   `print_string_com1`: ヌル終端文字列をCOM1ポートに出力します。
-   `print_al_hex`: `AL` レジスタの値を2桁の16進数文字列としてCOM1ポートに出力します。
-   `print_nibble_from_al`: `AL` の下位4ビットを16進文字として出力します。`print_al_hex` から使用されます。
-   `print_char_com1`: `AL` レジスタ内の単一文字をCOM1ポートに出力します。
