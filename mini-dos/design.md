# COMMAND.COM を動かすためのメモリイメージ

- 8086 CPUで、COMMAND.COMを動かしたい。
- マシンについて。
  - CPUは8086
  - モニタがメモリにイメージを書き込み後、CPUをリセットして起動する。
  - RAMが128KBあり、00000〜1FFFF番地にメインでマップされ、それ以降のアドレスにも繰り返し反映される。
    - 例: 20000-3FFFF番地、E0000-FFFFF番地にも同じRAM内容が見える。
  - この仕様により、1FFF0番地にリセットハンドラを置けば、CPUがリセットベクタとして参照するFFFF0番地に存在するように見える。
- 目標について。
  - COMMAND.COMを起動し、内部コマンド(VER, CLSなど)を実行できる。
  - モニタプログラムはIO命令で次の機能を提供する。
    - アスキーコードで1文字単位の入出力を提供する。
    - ログ記録
  - 割り込みハンドラを全て用意し、COMMAND.COMが要求した全ての割り込みをハンドルする。
    - 文字入出力はIO命令を使い実装する。
    - その他の内部コマンドに必要な機能を実装する。
    - TODO: 実装が必要なハンドラを列挙する。(下記に記載)
    - これらのハンドラは、呼び出された事やパラメータをログに記録する。
    - 最初は多くのハンドラをログ出力のみのスタブとして実装し、必要に応じて機能を実装していく。

- **実装が必要な割り込みハンドラ**
  - `INT 20h`: プログラム終了
  - `INT 21h`: DOS API。主要なファンクションは以下の通り。
    - **コンソール入出力:** `01h, 02h, 06h, 07h, 08h, 09h, 0Ah, 0Bh, 0Ch`
    - **ファイル操作:** `3Dh(Open), 3Eh(Close), 3Fh(Read), 40h(Write), 41h(Delete), 42h(Seek)`
    - **ファイル検索:** `4Eh(Find First), 4Fh(Find Next)`
    - **メモリ管理:** `48h(Allocate), 49h(Free), 4Ah(Resize)`
    - **プロセス制御:** `4Ch(Exit with code), 4Dh(Get return code)`
    - **情報取得:** `19h(Get current drive), 2Ah(Get date), 2Ch(Get time), 30h(Get DOS version), 51h(Get current PSP)`
    - **その他:** `1Ah(Set DTA), 2Fh(Get DTA), 25h(Set vector), 35h(Get vector)`
  - `INT 22h`: 終了アドレス
  - `INT 23h`: Ctrl-C ハンドラアドレス
  - `INT 24h`: クリティカルエラーハンドラアドレス
  - `INT 25h`: 絶対ディスク読み込み
  - `INT 26h`: 絶対ディスク書き込み
  - `INT 27h`: 常駐終了 (TSR)

- **[修正案]** メモリマップ
  - `COMMAND.COM` (15480バイト) と OSハンドラ (8KBを想定) のサイズを元に、具体的なメモリマップを定義する。
  - `00000-003FF` (1KB): 割り込みベクタテーブル (IVT)
  - `01000-10FFF`: COMMAND.COM のメイン作業領域 (PSP、コード、データ、スタックを含む64KB)
    - `01000-010FF`: PSP領域 (TPA内)
    - `01100-04D77`: COMMAND.COM のロード先 (15480 バイト)
  - `11000-1FFEF` (8KB弱): 割り込みハンドラおよびリセットハンドラ (OSコード領域)
  - `1FFF0-1FFFF`: リセットベクタ (物理アドレスFFFF0hへジャンプする命令を配置)

- **使用セグメントアドレス**
  - **OS (ハンドラ群):** `0x1E00` (物理アドレス `1E000h` に対応)
  - **COMMAND.COM (起動時):** `0x0100` (PSPが配置されるセグメント。物理アドレス `01000h` に対応)

- 実装戦略
  - 生成物はサイズ128KBのbinファイル
  - nasmを使って生成する。
  - ログを読める状態にするためのPythonスクリプトを作る。
  - ビルド方法の説明のために、Makefileを作る。
