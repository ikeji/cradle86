# ブートローダ設計書

## 1. 目的

標準的なPCアーキテクチャ（BIOSによるブート）上で、`mini-dos.img`がメモリの`0x00000`から`0x1FFFF`に展開された状態を再現し、OS本体の実行を開始させる。

これにより、`design.md`で定義された理想的な実行環境と、QEMUのような実環境とのギャップを埋める。

## 2. 成果物

- `bootable.img`: QEMUで直接起動可能なフロッピーディスクイメージ。

### イメージ構成

`bootable.img`は、以下の2つのファイルをこの順序で連結して作成される。

1.  `boot.bin` (512バイト): ブートローダ本体。
2.  `mini-dos.img` (128KB): OSとCOMMAND.COMを含む既存のイメージ。

```
+------------------------+
|                        |
|  boot.bin (512 bytes)  |  <- ディスクのセクタ1 (ブートセクタ)
|                        |
+------------------------+
|                        |
|                        |
|  mini-dos.img (128KB)  |  <- ディスクのセクタ2以降
|                        |
|                        |
+------------------------+
```

## 3. ブートローダの仕様 (`boot.asm`)

- **配置とサイズ:**
  - `org 0x7C00` としてアセンブルされる。
  - コードサイズは510バイト以内に収め、末尾にブートシグネチャ`0xAA55`を付与して合計512バイトとする。

- **実行フロー:**
  - 各ステップの主要なポイントで、デバッグ用の文字をCOM1ポート（`0x3F8`）に出力する。
  1.  **初期化:**
      - BIOSによってメモリの`0x7C00`にロードされ、実行が開始される。
      - 自身のスタックを安全な場所に設定する。
  2.  **ブートローダの退避:**
      - `mini-dos.img`のロード先（`0x00000` - `0x1FFFF`）と衝突しないよう、自身（512バイト）を安全なメモリ領域（例: `0x90000`）にコピーする。
      - コピー先の新しいアドレスにジャンプし、そこから実行を継続する。
  3.  **`mini-dos.img`のロードとコピー:**
      - BIOSのディスク読み込み機能 (`INT 13h, AH=02h`) を使用し、ディスクの第2セクタから256セクタ分（128KB）のデータを読み込む。
      - 読み込んだデータは、一時的にメモリの`0x2000:0x0000`（物理アドレス `0x20000`）から順に書き込む。
      - ロード中にエラーが発生した場合は、エラーメッセージをCOM1ポートに出力して停止する。
      - ロードが正常に完了したら、`0x20000`から`0x00000`へ128KB（256セクタ）のデータをコピーする。
  4.  **OSへのジャンプ:**
      - データのロードが正常に完了したら、`mini-dos.img`内のリセットベクタが配置されている物理アドレス `0x1FFF0` へジャンプする。
      - これにより、OS本体(`reset_handler`)へ制御が渡される。

## 4. メモリマップ

| 物理アドレス          | サイズ | 内容                                | 説明                                                 |
|-----------------------|--------|-------------------------------------|------------------------------------------------------|
| `0x00000` - `0x1FFFF` | 128KB  | `mini-dos.img` (最終)               | OSイメージの最終的なロード先。                       |
| `0x1FFF0`             | 4B     | OSのエントリポイント                | `mini-dos.img`ロード後にジャンプするアドレス。       |
| `0x20000` - `0x3FFFF` | 128KB  | `mini-dos.img` (一時)               | OSイメージの一時的なロード先。                       |
| `0x07C00` - `0x07DFF` | 512B   | ブートローダ (初期位置)             | BIOSによって最初にロードされる場所。                 |
| `0x0FC00`             | -      | スタックポインタ (`ss:sp`) の初期値 |                                                      |
| `0x47C00` - `0x47DFF` | 512B   | ブートローダ (退避先)               | `mini-dos.img`のロード前に自身をコピーする場所。     |
| `0x4FC00`             | -      | スタックポインタ (`ss:sp`) の初期値 | 退避後のブートローダが使用するスタック領域のトップ。 |


## 5. ビルドプロセス (`Makefile`の変更)

1.  `boot.asm`を`nasm`でアセンブルし、`boot.bin` (512バイト) を生成する。
2.  既存のプロセスで`main.asm`（将来の`kernel.asm`）から`mini-dos.img` (128KB) を生成する。
3.  `cat`コマンド（または同等の機能）を使い、`boot.bin`と`mini-dos.img`を連結して、最終的な成果物`bootable.img`を生成する。
4.  `make run`ターゲットは、この`bootable.img`をQEMUで実行するように変更する。
